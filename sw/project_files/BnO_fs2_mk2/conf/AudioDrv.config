/**
*  @file      AudioSrv.Config
*  @brief     Config data for audio server 
*  @project   iBT150 
*  @author    Johnny Fan
*  @date      15-Sep-2014
*  @copyright Tymphany Ltd.
*/

#include "AudioSrv.h"
#include "product.config"
#include "deviceTypes.h"
#include "limits.h" //UINT_MAX

//DSP
#include "ADAU1451_IC_1_PARAM.h" 


/*****************************************************************
 * Config Data
 *****************************************************************/
/* Based on 4dB ADC gain,
 *                                          2000 mVrms  => DSP get 0dB
 *   iPhone6 output 0dB 1KHz sine wave =>    504 mVrms  => DSP get -11.8dB
 *                                   noise 0.950 mVrms  => DSP get -66.3dB
 *                                   noise 0.380 mVrms  => DSP get -74.3dB
 *                                   noise 0.150 mVrms  => DSP get -83.3dB
 */
#define AUDIO_AUXIN_DETECT_LOW_DB       -66  /* dB, 950uVrms */
#define AUDIO_AUXIN_DETECT_MID_DB       -74  /* dB, 380uVrms */
#define AUDIO_AUXIN_DETECT_HIGH_DB      -82  /* dB, 150uVrms */

#define AUDIO_AUXIN_DETECT_PEROID_MSEC  1000 /* ms */
#define AUDIO_AUXIN_DETECT_SMOOTH_RATE  0.3  /* smooth rate, between 0.0~1.0 */

/* 1. For Aux-in ADC, FS2 traget to transfer 1Vrms input to 0dBFS output
 * 2. Aux-in circit get 67% (reduce before ADC)
 * 3. ADC spec says, 2.1Vrms lead to 0dBFS output
 * => ADC gain = 2.1/2.0/0.67 = 1.554 = 3.829dBFS, near 4dBFS
 */
#define AUDIO_AUXIN_GAIN   PCM1862_PGA_4dB


/* measured in ms */
#define AUDIO_ACTIVE_DELAY_UNMUTE_TIME          500
#define AUDIO_ACTIVE_MUSIC_DETECT_TIME          200
#define AUDIO_SWITCH_CHANNEL_DELAY_TIME         500 

/* Time Period */
#define AUDIO_PRINT_PREIOD_IN_MS      5000


/* Pin usage */
#define  AMP_WAKEUP(x)           GpioDrv_SetBit(&(x),GPIO_OUT_AMP_SDZ) //SDZ: Active LOW
#define  AMP_SHUTDOWN(x)         GpioDrv_ClearBit(&(x),GPIO_OUT_AMP_SDZ)

#define  SYSPWR_ENABLE(x)        GpioDrv_SetBit(&(x),GPIO_OUT_SYSPWR_ON) //Active HIGH
#define  SYSPWR_DISABLE(x)       GpioDrv_ClearBit(&(x),GPIO_OUT_SYSPWR_ON)



/*****************************************************************
 * DSP NTC Temperature Register
 *****************************************************************/
#define DSP_TEMP_WF_AMP_1_REGISTER    MOD_THERMAL_SYSTEM_DC_TEMPWFAMP_1_DCINPALG145X2VALUE_ADDR
#define DSP_TEMP_WF_AMP_2_REGISTER    MOD_THERMAL_SYSTEM_DC_TEMPWFAMP_2_DCINPALG145X3VALUE_ADDR
#define DSP_TEMP_WF_SPK_REGISTER      MOD_THERMAL_SYSTEM_DC_TEMPWFSPK_DCINPALG145X4VALUE_ADDR
#define DSP_TEMP_MID_SPK_A_REGISTER   MOD_THERMAL_SYSTEM_DC_TEMPMIDSPK_A_DCINPALG145X5VALUE_ADDR
#define DSP_TEMP_MID_SPK_B_REGISTER   MOD_THERMAL_SYSTEM_DC_TEMPMIDSPK_B_DCINPALG145X6VALUE_ADDR
#define DSP_TEMP_TW_AMP_REGISTER      MOD_THERMAL_SYSTEM_DC_TEMPTWAMP_DCINPALG145X7VALUE_ADDR

#define DSP_READBACK_TEMP_WF_AMP_1_REGISTER    MOD_THERMAL_SYSTEM_READBACK_TEMPWFAMP_1_READBACKALGSIGMA3001_ADDR
#define DSP_READBACK_TEMP_WF_AMP_2_REGISTER    MOD_THERMAL_SYSTEM_READBACK_TEMPWFAMP_2_READBACKALGSIGMA3002_ADDR
#define DSP_READBACK_TEMP_WF_SPK_REGISTER      MOD_THERMAL_SYSTEM_READBACK_TEMPWFSPK_READBACKALGSIGMA3003_ADDR
#define DSP_READBACK_TEMP_MID_SPK_A_REGISTER   MOD_THERMAL_SYSTEM_READBACK_TEMPMIDSPK_A_READBACKALGSIGMA3004_ADDR
#define DSP_READBACK_TEMP_MID_SPK_B_REGISTER   MOD_THERMAL_SYSTEM_READBACK_TEMPMIDSPK_B_READBACKALGSIGMA3005_ADDR
#define DSP_READBACK_TEMP_TW_AMP_REGISTER      MOD_THERMAL_SYSTEM_READBACK_TEMPTWAMP_READBACKALGSIGMA3006_ADDR

#define DSP_READBACK_OVERHEAT_GAIN_WF_REGISTER    MOD_THERMAL_SYSTEM_READBACK_WFGAIN_READBACKALGSIGMA3007_ADDR
#define DSP_READBACK_OVERHEAT_GAIN_MID_REGISTER   MOD_THERMAL_SYSTEM_READBACK_MIDGAIN_READBACKALGSIGMA30027_ADDR
#define DSP_READBACK_OVERHEAT_GAIN_TW_REGISTER    MOD_THERMAL_SYSTEM_READBACK_TWGAIN_READBACKALGSIGMA30033_ADDR

#define DSP_READBACK_OVERHEAT_COIL_TEMP_WF_REGISTER    MOD_TEMPWOOFER_READBACK_WFCOILTEMP_READBACKALGSIGMA30024_ADDR
#define DSP_READBACK_OVERHEAT_COIL_TEMP_MID_A_REGISTER MOD_TEMPMIDA_READBACK_MIDACOILTEMP_READBACKALGSIGMA30018_ADDR
#define DSP_READBACK_OVERHEAT_COIL_TEMP_MID_B_REGISTER MOD_TEMPMIDB_READBACK_MIDBCOILTEMP_READBACKALGSIGMA30023_ADDR
#define DSP_READBACK_OVERHEAT_COIL_TEMP_TW_REGISTER    MOD_TEMPTWEETER_READBACK_TWCOILTEMP_READBACKALGSIGMA30025_ADDR

#define SIGMASTUDIOTYPE_8_24_CONVERT(x) (x)
#define DSP_OUTPUT_GAIN_LINEAR MOD_GAIN1_2_GAINALGNS145X45GAIN_VALUE

/* When read from "RMS level detect", it loss 3.829dB (AP say 0dBFS sine wave, but it say -3.829dBFS)
 * To workaround, we add 3.829 after read from level detector
 */
#define DSP_GAIN_READ_ADD_DB 4.0



/*****************************************************************
 * Temperature
 *****************************************************************/
#define AUDIO_TEMP_MAX   SHRT_MAX
#define AUDIO_TEMP_MIN   SHRT_MIN

const sRange ampTempLevels[TL_NUM] =
{ // upper              lower
    {AUDIO_TEMP_MAX,    95            },  // 0:TL_CRITICAL, shutdown battery & system
    {92,                90            },  // 1:TL_SERIOUS, shutdown amplifier
    {AUDIO_TEMP_MAX,    AUDIO_TEMP_MAX},  // 0:TL_CRITICAL, shutdown battery & system
    {80,                AUDIO_TEMP_MIN},  // 3:TL_NORMAL
    {AUDIO_TEMP_MIN,    AUDIO_TEMP_MIN},  // 4:TL_SUBNORMAL, fake level, never triggered
    {AUDIO_TEMP_MIN,    AUDIO_TEMP_MIN},  // 5:TL_CRITICAL_COLD, fake level, never trigger
};

const sRange spkTempLevels[TL_NUM] =
{ // upper              lower
    {AUDIO_TEMP_MAX,    95            },  // 0:TL_CRITICAL, shutdown battery & system
    {92,                90            },  // 1:TL_SERIOUS, shutdown amplifier
    {AUDIO_TEMP_MAX,    AUDIO_TEMP_MAX},  // 0:TL_CRITICAL, shutdown battery & system
    {80,                AUDIO_TEMP_MIN},  // 3:TL_NORMAL
    {AUDIO_TEMP_MIN,    AUDIO_TEMP_MIN},  // 4:TL_SUBNORMAL, fake level, never triggered
    {AUDIO_TEMP_MIN,    AUDIO_TEMP_MIN},  // 5:TL_CRITICAL_COLD, fake level, never trigger
};

#define TEMP_DETECT_SMOOTH_RATE  (30)  /*  smooth rate in %, between (0.0~1.0)*100  */

#define TEMPERATURE_POSITIONS_NUM  ArraySize(audioNtcTempTable)

//array index is "degree C"
const uint16 audioNtcTempTable[] =
{
    3848,    3836,    3823,    3810,    3796,    3782,    3767,    3752,    3736,    3720, //0~9 degree C
    3703,    3685,    3667,    3649,    3629,    3610,    3589,    3568,    3546,    3524, //10~19 degree C
    3501,    3478,    3453,    3429,    3403,    3377,    3351,    3324,    3296,    3268, //20~29 degree C
    3239,    3209,    3179,    3149,    3118,    3086,    3054,    3021,    2988,    2955, //30~39 degree C
    2921,    2887,    2852,    2817,    2782,    2746,    2710,    2674,    2637,    2601, //40~49 degree C
    2564,    2527,    2490,    2453,    2415,    2378,    2341,    2303,    2266,    2229, //50~59 degree C
    2191,    2154,    2117,    2081,    2044,    2007,    1971,    1935,    1900,    1864, //60~69 degree C
    1829,    1794,    1760,    1725,    1692,    1658,    1625,    1592,    1560,    1528, //70~79 degree C
    1497,    1466,    1435,    1405,    1376,    1346,    1318,    1289,    1262,    1234, //80~89 degree C
    1207,    1181,    1155,    1130,    1105,    1080,    1056,    1033,    1010,     987, //90~99 degree C
     965,     943,     922,     901,     881,     861,     841,     822,     804,     785, //100~109 degree C
     767,     750,     733,     716,     700,     684,     668,     653,     638,     624, //110~119 degree C
     609,     595,     582,     569,     556,     543,     531,     519,     507,     496, //120~119 degree C
     485                                                                                   //130 degree C
                                                                                           //otherwise, 131 degree C
};


#define AUDIO_WOOFER_MUTE_CHANNEL_MASK          (0x08)
#define AUDIO_MIDDLEA_MUTE_CHANNEL_MASK         (0x04)
#define AUDIO_MIDDLEB_MUTE_CHANNEL_MASK         (0x02)
#define AUDIO_TWEETER_MUTE_CHANNEL_MASK         (0x01)


